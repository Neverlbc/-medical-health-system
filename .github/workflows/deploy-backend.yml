# ============================================================
# åç«¯è‡ªåŠ¨éƒ¨ç½² â€” Spring Boot Maven â†’ é˜¿é‡Œäº‘ ECS
# ============================================================
# è§¦å‘æ¡ä»¶ï¼špush åˆ° main åˆ†æ”¯ä¸” medical-backend/ æœ‰å˜æ›´
#
# âš ï¸ éœ€è¦åœ¨ GitHub â†’ Settings â†’ Secrets and variables â†’ Actions
#    ä¸­é…ç½®ä»¥ä¸‹ Secretsï¼š
#
#   SERVER_HOST        â€” æœåŠ¡å™¨å…¬ç½‘ IPï¼ˆé˜¿é‡Œäº‘ ECSï¼‰
#   SERVER_USER        â€” SSH ç”¨æˆ·åï¼ˆé€šå¸¸ rootï¼‰
#   SERVER_SSH_KEY     â€” SSH ç§é’¥ï¼ˆå®Œæ•´ PEM æ ¼å¼ï¼‰
#   SERVER_PORT        â€” SSH ç«¯å£ï¼ˆé»˜è®¤ 22ï¼Œå¯é€‰ï¼‰
#   DB_PASSWORD        â€” ç”Ÿäº§æ•°æ®åº“å¯†ç ï¼ˆæ³¨å…¥åˆ°å¯åŠ¨å‘½ä»¤ï¼‰
# ============================================================

name: âš™ï¸ Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'medical-backend/**'
      - '.github/workflows/deploy-backend.yml'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy Backend
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: medical-backend

    steps:
      # ---- 1. æ£€å‡ºä»£ç  ----
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ---- 2. é…ç½® JDK 17 ----
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # ---- 3. Maven æ„å»ºï¼ˆè·³è¿‡æµ‹è¯•åŠ é€Ÿéƒ¨ç½²ï¼‰ ----
      - name: ğŸ—ï¸ Build with Maven
        run: mvn clean package -DskipTests -pl medical-admin -am

      # ---- 4. éªŒè¯ JAR åŒ… ----
      - name: âœ… Verify JAR artifact
        run: |
          JAR_PATH="medical-admin/target/medical-admin.jar"
          if [ ! -f "$JAR_PATH" ]; then
            echo "âŒ JAR file not found: $JAR_PATH"
            exit 1
          fi
          echo "âœ… JAR size: $(du -h $JAR_PATH | cut -f1)"

      # ---- 5. ä¸Šä¼ æ„å»ºäº§ç‰© ----
      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: medical-backend/medical-admin/target/medical-admin.jar
          retention-days: 7

      # ---- 6. éƒ¨ç½² JAR åˆ°æœåŠ¡å™¨ ----
      - name: ğŸ“¦ Upload JAR to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER || 'root' }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: medical-backend/medical-admin/target/medical-admin.jar
          target: /www/wwwroot/medical-backend/
          strip_components: 4  # å»æ‰ medical-backend/medical-admin/target/ å‰ç¼€

      # ---- 7. é‡å¯åç«¯æœåŠ¡ ----
      - name: ğŸ”„ Restart backend service
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER || 'root' }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸ”„ Restarting medical backend service..."

            # å¤‡ä»½æ—§ JARï¼ˆä¿ç•™æœ€è¿‘ 3 ä¸ªç‰ˆæœ¬ï¼‰
            DEPLOY_DIR="/www/wwwroot/medical-backend"
            BACKUP_DIR="$DEPLOY_DIR/backup"
            mkdir -p "$BACKUP_DIR"

            if [ -f "$DEPLOY_DIR/medical-admin.jar.running" ]; then
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              cp "$DEPLOY_DIR/medical-admin.jar.running" "$BACKUP_DIR/medical-admin_${TIMESTAMP}.jar"
              # åªä¿ç•™æœ€è¿‘ 3 ä¸ªå¤‡ä»½
              ls -t "$BACKUP_DIR"/medical-admin_*.jar 2>/dev/null | tail -n +4 | xargs -r rm
            fi

            # æ›¿æ¢è¿è¡Œä¸­çš„ JAR
            cp "$DEPLOY_DIR/medical-admin.jar" "$DEPLOY_DIR/medical-admin.jar.running" 2>/dev/null || \
            mv "$DEPLOY_DIR/medical-admin.jar" "$DEPLOY_DIR/medical-admin.jar.running"

            # é‡å¯ Systemd æœåŠ¡
            sudo systemctl restart medical
            sleep 5

            # å¥åº·æ£€æŸ¥
            if sudo systemctl is-active --quiet medical; then
              echo "âœ… Backend service is running!"
              sudo systemctl status medical --no-pager -l | head -20
            else
              echo "âŒ Backend service failed to start!"
              sudo journalctl -u medical.service --no-pager -n 30
              exit 1
            fi
