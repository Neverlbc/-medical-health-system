# ============================================================
# åç«¯è‡ªåŠ¨éƒ¨ç½² â€” Spring Boot Maven â†’ é˜¿é‡Œäº‘ ECS
# ============================================================
# è§¦å‘æ¡ä»¶ï¼špush åˆ° main åˆ†æ”¯ä¸” medical-backend/ æœ‰å˜æ›´
#
# âš ï¸ éœ€è¦åœ¨ GitHub â†’ Settings â†’ Secrets and variables â†’ Actions
#    ä¸­é…ç½®ä»¥ä¸‹ Secretsï¼š
#
#   SERVER_HOST        â€” æœåŠ¡å™¨å…¬ç½‘ IPï¼ˆé˜¿é‡Œäº‘ ECSï¼‰
#   SERVER_USER        â€” SSH ç”¨æˆ·åï¼ˆé€šå¸¸ rootï¼‰
#   SERVER_SSH_KEY     â€” SSH ç§é’¥ï¼ˆå®Œæ•´ PEM æ ¼å¼ï¼‰
#   SERVER_PORT        â€” SSH ç«¯å£ï¼ˆé»˜è®¤ 22ï¼Œå¯é€‰ï¼‰
#   DB_PASSWORD        â€” ç”Ÿäº§æ•°æ®åº“å¯†ç ï¼ˆæ³¨å…¥åˆ°å¯åŠ¨å‘½ä»¤ï¼‰
# ============================================================

name: âš™ï¸ Deploy Backend

on:
  push:
    branches: [main]
    paths:
      - 'medical-backend/**'
      - '.github/workflows/deploy-backend.yml'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy Backend
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: medical-backend

    steps:
      # ---- 1. æ£€å‡ºä»£ç  ----
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ---- 2. é…ç½® JDK 17 ----
      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # ---- 3. Maven æ„å»ºï¼ˆè·³è¿‡æµ‹è¯•åŠ é€Ÿéƒ¨ç½²ï¼‰ ----
      - name: ğŸ—ï¸ Build with Maven
        run: mvn clean package -DskipTests -pl medical-admin -am

      # ---- 4. éªŒè¯ JAR åŒ… ----
      - name: âœ… Verify JAR artifact
        run: |
          JAR_PATH="medical-admin/target/medical-admin.jar"
          if [ ! -f "$JAR_PATH" ]; then
            echo "âŒ JAR file not found: $JAR_PATH"
            exit 1
          fi
          echo "âœ… JAR size: $(du -h $JAR_PATH | cut -f1)"

      # ---- 5. ä¸Šä¼ æ„å»ºäº§ç‰© ----
      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: medical-backend/medical-admin/target/medical-admin.jar
          retention-days: 7

      # ---- 6. åˆå§‹åŒ–æœåŠ¡å™¨ç¯å¢ƒï¼ˆé¦–æ¬¡éƒ¨ç½²è‡ªåŠ¨åˆ›å»ºï¼‰ ----
      - name: ğŸ”§ Initialize server environment
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER || 'root' }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            mkdir -p /www/wwwroot/medical-backend/backup

            # ç¡®ä¿ JDK 17 å·²å®‰è£…
            if ! java -version 2>&1 | grep -q "17"; then
              echo "ğŸ“¦ Installing JDK 17..."
              apt update && apt install -y openjdk-17-jdk
            fi
            echo "â˜• Java: $(java -version 2>&1 | head -1)"

            # ç¡®ä¿ Systemd æœåŠ¡å­˜åœ¨
            if [ ! -f /etc/systemd/system/medical.service ]; then
              echo "âš™ï¸ Creating medical.service..."
              cat > /etc/systemd/system/medical.service << 'SVCEOF'
            [Unit]
            Description=Medical Health System Backend
            After=network.target

            [Service]
            User=root
            WorkingDirectory=/www/wwwroot/medical-backend
            ExecStart=/usr/bin/java -Xms512m -Xmx1024m -XX:+UseG1GC -jar medical-admin.jar
            SuccessExitStatus=143
            Restart=always
            RestartSec=10

            [Install]
            WantedBy=multi-user.target
            SVCEOF
              systemctl daemon-reload
              systemctl enable medical
            fi
            echo "âœ… Server environment ready"

      # ---- 7. éƒ¨ç½² JAR åˆ°æœåŠ¡å™¨ ----
      - name: ğŸ“¦ Upload JAR to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER || 'root' }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: medical-backend/medical-admin/target/medical-admin.jar
          target: /tmp/medical-deploy/
          strip_components: 3

      # ---- 8. éƒ¨ç½²å¹¶é‡å¯åç«¯æœåŠ¡ ----
      - name: ğŸ”„ Deploy and restart backend service
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER || 'root' }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e
            DEPLOY_DIR="/www/wwwroot/medical-backend"
            BACKUP_DIR="$DEPLOY_DIR/backup"
            SRC="/tmp/medical-deploy/medical-admin.jar"

            echo "ğŸ“‹ Checking uploaded JAR..."
            if [ ! -f "$SRC" ]; then
              echo "âŒ JAR not found at $SRC"
              echo "ğŸ“‚ Contents of /tmp/medical-deploy/:"
              find /tmp/medical-deploy/ -type f 2>/dev/null || echo "  (empty)"
              exit 1
            fi
            echo "âœ… JAR found: $(du -h $SRC | cut -f1)"

            # åœæ­¢å½“å‰æœåŠ¡
            systemctl stop medical 2>/dev/null || true

            # å¤‡ä»½æ—§ JAR
            if [ -f "$DEPLOY_DIR/medical-admin.jar" ] && [ -s "$DEPLOY_DIR/medical-admin.jar" ]; then
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              cp "$DEPLOY_DIR/medical-admin.jar" "$BACKUP_DIR/medical-admin_${TIMESTAMP}.jar"
              ls -t "$BACKUP_DIR"/medical-admin_*.jar 2>/dev/null | tail -n +4 | xargs -r rm
            fi

            # ç§»åŠ¨æ–° JAR åˆ°éƒ¨ç½²ç›®å½•
            mv "$SRC" "$DEPLOY_DIR/medical-admin.jar"
            echo "âœ… JAR deployed to $DEPLOY_DIR/medical-admin.jar"

            # é‡å¯æœåŠ¡
            systemctl daemon-reload
            systemctl restart medical
            sleep 10

            # å¥åº·æ£€æŸ¥
            if systemctl is-active --quiet medical; then
              echo "âœ… Backend service is running!"
              systemctl status medical --no-pager -l | head -20
            else
              echo "âŒ Backend service failed to start!"
              journalctl -u medical.service --no-pager -n 30
              exit 1
            fi
