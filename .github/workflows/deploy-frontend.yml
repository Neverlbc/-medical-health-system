# ============================================================
# å‰ç«¯è‡ªåŠ¨éƒ¨ç½² â€” Vue 3 + Vite â†’ é˜¿é‡Œäº‘ ECS
# ============================================================
# è§¦å‘æ¡ä»¶ï¼špush åˆ° main åˆ†æ”¯ä¸” medical-frontend/ æœ‰å˜æ›´
#
# âš ï¸ éœ€è¦åœ¨ GitHub â†’ Settings â†’ Secrets and variables â†’ Actions
#    ä¸­é…ç½®ä»¥ä¸‹ Secretsï¼š
#
#   SERVER_HOST        â€” æœåŠ¡å™¨å…¬ç½‘ IPï¼ˆé˜¿é‡Œäº‘ ECSï¼‰
#   SERVER_USER        â€” SSH ç”¨æˆ·åï¼ˆé€šå¸¸ rootï¼‰
#   SERVER_SSH_KEY     â€” SSH ç§é’¥ï¼ˆå®Œæ•´ PEM æ ¼å¼ï¼Œå¯¹åº”æœåŠ¡å™¨ authorized_keysï¼‰
#   SERVER_PORT        â€” SSH ç«¯å£ï¼ˆé»˜è®¤ 22ï¼Œå¯é€‰ï¼‰
# ============================================================

name: ðŸŽ¨ Deploy Frontend

on:
  push:
    branches: [main]
    paths:
      - 'medical-frontend/**'
      - '.github/workflows/deploy-frontend.yml'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy Frontend
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: medical-frontend

    steps:
      # ---- 1. æ£€å‡ºä»£ç  ----
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ---- 2. é…ç½® Node.js ----
      - name: ðŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: medical-frontend/package-lock.json

      # ---- 3. å®‰è£…ä¾èµ– ----
      - name: ðŸ“¦ Install dependencies
        run: npm ci

      # ---- 4. ä»£ç æ£€æŸ¥ ----
      - name: ðŸ” Lint check
        run: npm run lint
        continue-on-error: true

      # ---- 5. æž„å»ºç”Ÿäº§åŒ… ----
      - name: ðŸ—ï¸ Build production
        run: npm run build

      # ---- 6. ä¸Šä¼ æž„å»ºäº§ç‰©ï¼ˆå¯åœ¨ Actions ä¸­ä¸‹è½½æŽ’æŸ¥ï¼‰ ----
      - name: ðŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: medical-frontend/dist
          retention-days: 7

      # ---- 7. åˆå§‹åŒ–æœåŠ¡å™¨çŽ¯å¢ƒï¼ˆé¦–æ¬¡éƒ¨ç½²è‡ªåŠ¨åˆ›å»ºï¼‰ ----
      - name: ðŸ”§ Initialize server environment
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER || 'root' }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # åˆ›å»ºå‰ç«¯éƒ¨ç½²ç›®å½•
            mkdir -p /www/wwwroot/medical-frontend/dist

            # ç¡®ä¿ Nginx å·²å®‰è£…
            if ! command -v nginx &> /dev/null; then
              echo "ðŸ“¦ Installing Nginx..."
              apt update && apt install -y nginx
              systemctl enable nginx
            fi

            # ç¡®ä¿ rsync å·²å®‰è£…
            if ! command -v rsync &> /dev/null; then
              echo "ðŸ“¦ Installing rsync..."
              apt install -y rsync
            fi

            # åˆ›å»º Nginx ç«™ç‚¹é…ç½®ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
            if [ ! -f /etc/nginx/sites-available/medical ]; then
              echo "ðŸŒ Creating Nginx config..."
              cat > /etc/nginx/sites-available/medical << 'NGEOF'
            server {
                listen 80;
                server_name _;
                root /www/wwwroot/medical-frontend/dist;
                index index.html;

                location / {
                    try_files $uri $uri/ /index.html;
                }

                location /api/ {
                    proxy_pass http://127.0.0.1:8080/api/;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }

                gzip on;
                gzip_types text/plain text/css application/json application/javascript text/xml;
            }
            NGEOF
              ln -sf /etc/nginx/sites-available/medical /etc/nginx/sites-enabled/medical
              rm -f /etc/nginx/sites-enabled/default
            fi
            echo "âœ… Server environment ready"

      # ---- 8. éƒ¨ç½²åˆ°æœåŠ¡å™¨ ----
      - name: ðŸš€ Deploy to server via rsync
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avz --delete --exclude='.git'
          path: medical-frontend/dist/
          remote_path: /www/wwwroot/medical-frontend/dist/
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USER || 'root' }}
          remote_key: ${{ secrets.SERVER_SSH_KEY }}
          remote_port: ${{ secrets.SERVER_PORT || 22 }}

      # ---- 9. é‡è½½ Nginx ----
      - name: ðŸ”„ Reload Nginx
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER || 'root' }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ðŸ”„ Reloading Nginx..."
            nginx -t && systemctl reload nginx
            echo "âœ… Frontend deployed successfully!"
