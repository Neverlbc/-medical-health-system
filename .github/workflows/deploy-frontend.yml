# ============================================================
# å‰ç«¯è‡ªåŠ¨éƒ¨ç½² â€” Vue 3 + Vite â†’ é˜¿é‡Œäº‘ ECS
# ============================================================
# è§¦å‘æ¡ä»¶ï¼špush åˆ° main åˆ†æ”¯ä¸” medical-frontend/ æœ‰å˜æ›´
#
# âš ï¸ éœ€è¦åœ¨ GitHub â†’ Settings â†’ Secrets and variables â†’ Actions
#    ä¸­é…ç½®ä»¥ä¸‹ Secretsï¼š
#
#   SERVER_HOST        â€” æœåŠ¡å™¨å…¬ç½‘ IPï¼ˆé˜¿é‡Œäº‘ ECSï¼‰
#   SERVER_USER        â€” SSH ç”¨æˆ·åï¼ˆé€šå¸¸ rootï¼‰
#   SERVER_SSH_KEY     â€” SSH ç§é’¥ï¼ˆå®Œæ•´ PEM æ ¼å¼ï¼Œå¯¹åº”æœåŠ¡å™¨ authorized_keysï¼‰
#   SERVER_PORT        â€” SSH ç«¯å£ï¼ˆé»˜è®¤ 22ï¼Œå¯é€‰ï¼‰
# ============================================================

name: ğŸ¨ Deploy Frontend

on:
  push:
    branches: [main]
    paths:
      - 'medical-frontend/**'
      - '.github/workflows/deploy-frontend.yml'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy Frontend
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: medical-frontend

    steps:
      # ---- 1. æ£€å‡ºä»£ç  ----
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ---- 2. é…ç½® Node.js ----
      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: medical-frontend/package-lock.json

      # ---- 3. å®‰è£…ä¾èµ– ----
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # ---- 4. ä»£ç æ£€æŸ¥ ----
      - name: ğŸ” Lint check
        run: npm run lint
        continue-on-error: true

      # ---- 5. æ„å»ºç”Ÿäº§åŒ… ----
      - name: ğŸ—ï¸ Build production
        run: npm run build

      # ---- 6. ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆå¯åœ¨ Actions ä¸­ä¸‹è½½æ’æŸ¥ï¼‰ ----
      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: medical-frontend/dist
          retention-days: 7

      # ---- 7. éƒ¨ç½²åˆ°æœåŠ¡å™¨ ----
      - name: ğŸš€ Deploy to server via rsync
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avz --delete --exclude='.git'
          path: medical-frontend/dist/
          remote_path: /www/wwwroot/medical-frontend/dist/
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USER || 'root' }}
          remote_key: ${{ secrets.SERVER_SSH_KEY }}
          remote_port: ${{ secrets.SERVER_PORT || 22 }}

      # ---- 8. é‡è½½ Nginx ----
      - name: ğŸ”„ Reload Nginx
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER || 'root' }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸ”„ Reloading Nginx..."
            sudo nginx -t && sudo systemctl reload nginx
            echo "âœ… Frontend deployed successfully!"
