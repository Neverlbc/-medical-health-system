-- ====================================================
-- 智慧医疗健康管理系统 - 数据库初始化脚本
-- Database: medical_health
-- Author: 刘柏城
-- Date: 2025-11-06
-- ====================================================

-- 设置字符集
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ====================================================
-- 1. 系统用户表 (sys_user)
-- ====================================================
DROP TABLE IF EXISTS `sys_user`;
CREATE TABLE `sys_user` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `password` VARCHAR(100) NOT NULL COMMENT '密码(加密)',
  `nickname` VARCHAR(50) DEFAULT NULL COMMENT '昵称',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
  `role` VARCHAR(20) NOT NULL COMMENT '角色(ADMIN/DOCTOR/PATIENT)',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态(0:禁用 1:正常)',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `last_login_time` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  `deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除(0:否 1:是)',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_phone` (`phone`),
  KEY `idx_role` (`role`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统用户表';

-- ====================================================
-- 2. 患者信息表 (patient_info)
-- ====================================================
DROP TABLE IF EXISTS `patient_info`;
CREATE TABLE `patient_info` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '患者ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID(外键)',
  `real_name` VARCHAR(50) NOT NULL COMMENT '真实姓名',
  `gender` TINYINT NOT NULL COMMENT '性别(0:女 1:男)',
  `birthday` DATE DEFAULT NULL COMMENT '出生日期',
  `age` INT DEFAULT NULL COMMENT '年龄',
  `id_card` VARCHAR(18) DEFAULT NULL COMMENT '身份证号',
  `address` VARCHAR(200) DEFAULT NULL COMMENT '详细地址',
  `emergency_contact` VARCHAR(50) DEFAULT NULL COMMENT '紧急联系人',
  `emergency_phone` VARCHAR(20) DEFAULT NULL COMMENT '紧急联系电话',
  `height` DECIMAL(5,2) DEFAULT NULL COMMENT '身高(cm)',
  `weight` DECIMAL(5,2) DEFAULT NULL COMMENT '体重(kg)',
  `blood_type` VARCHAR(10) DEFAULT NULL COMMENT '血型(A/B/AB/O)',
  `allergies` TEXT DEFAULT NULL COMMENT '过敏史',
  `family_history` TEXT DEFAULT NULL COMMENT '家族病史',
  `medical_history` TEXT DEFAULT NULL COMMENT '既往病史',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`),
  UNIQUE KEY `uk_id_card` (`id_card`),
  CONSTRAINT `fk_patient_user` FOREIGN KEY (`user_id`) REFERENCES `sys_user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='患者信息表';

-- ====================================================
-- 3. 医生信息表 (doctor_info)
-- ====================================================
DROP TABLE IF EXISTS `doctor_info`;
CREATE TABLE `doctor_info` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '医生ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID(外键)',
  `real_name` VARCHAR(50) NOT NULL COMMENT '真实姓名',
  `gender` TINYINT NOT NULL COMMENT '性别(0:女 1:男)',
  `department` VARCHAR(50) NOT NULL COMMENT '科室',
  `title` VARCHAR(50) DEFAULT NULL COMMENT '职称',
  `specialty` VARCHAR(200) DEFAULT NULL COMMENT '专长',
  `introduction` TEXT DEFAULT NULL COMMENT '个人简介',
  `certificate_no` VARCHAR(50) DEFAULT NULL COMMENT '执业证书号',
  `work_years` INT DEFAULT NULL COMMENT '从业年限',
  `consultation_fee` DECIMAL(10,2) DEFAULT NULL COMMENT '挂号费(元)',
  `rating` DECIMAL(3,2) DEFAULT 5.00 COMMENT '评分(0-5)',
  `patient_count` INT DEFAULT 0 COMMENT '接诊患者数',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态(0:停诊 1:正常)',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`),
  KEY `idx_department` (`department`),
  KEY `idx_title` (`title`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_doctor_user` FOREIGN KEY (`user_id`) REFERENCES `sys_user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='医生信息表';

-- ====================================================
-- 4. 健康数据表 (health_data)
-- ====================================================
DROP TABLE IF EXISTS `health_data`;
CREATE TABLE `health_data` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '数据ID',
  `patient_id` BIGINT NOT NULL COMMENT '患者ID(外键)',
  `data_type` VARCHAR(20) NOT NULL COMMENT '数据类型(BLOOD_PRESSURE/BLOOD_SUGAR/HEART_RATE/TEMPERATURE/WEIGHT)',
  `systolic_pressure` INT DEFAULT NULL COMMENT '收缩压(mmHg)',
  `diastolic_pressure` INT DEFAULT NULL COMMENT '舒张压(mmHg)',
  `blood_sugar` DECIMAL(5,2) DEFAULT NULL COMMENT '血糖值(mmol/L)',
  `heart_rate` INT DEFAULT NULL COMMENT '心率(次/分)',
  `temperature` DECIMAL(4,2) DEFAULT NULL COMMENT '体温(℃)',
  `weight` DECIMAL(5,2) DEFAULT NULL COMMENT '体重(kg)',
  `remark` VARCHAR(200) DEFAULT NULL COMMENT '备注',
  `measure_time` DATETIME NOT NULL COMMENT '测量时间',
  `status` TINYINT NOT NULL DEFAULT 0 COMMENT '状态(0:正常 1:轻度异常 2:中度异常 3:重度异常 4:危险)',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_patient_id` (`patient_id`),
  KEY `idx_data_type` (`data_type`),
  KEY `idx_measure_time` (`measure_time`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_health_patient` FOREIGN KEY (`patient_id`) REFERENCES `patient_info` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='健康数据表';

-- ====================================================
-- 5. 医疗报告表 (medical_report)
-- ====================================================
DROP TABLE IF EXISTS `medical_report`;
CREATE TABLE `medical_report` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '报告ID',
  `patient_id` BIGINT NOT NULL COMMENT '患者ID(外键)',
  `report_type` VARCHAR(50) NOT NULL COMMENT '报告类型(体检报告/检验报告/影像报告)',
  `report_name` VARCHAR(100) NOT NULL COMMENT '报告名称',
  `hospital` VARCHAR(100) DEFAULT NULL COMMENT '医院名称',
  `report_data` JSON DEFAULT NULL COMMENT '报告数据(JSON格式)',
  `file_url` VARCHAR(255) DEFAULT NULL COMMENT '文件URL',
  `ai_analysis` TEXT DEFAULT NULL COMMENT 'AI分析结果',
  `ai_suggestions` TEXT DEFAULT NULL COMMENT 'AI建议',
  `report_date` DATE DEFAULT NULL COMMENT '报告日期',
  `upload_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_patient_id` (`patient_id`),
  KEY `idx_report_type` (`report_type`),
  KEY `idx_report_date` (`report_date`),
  CONSTRAINT `fk_report_patient` FOREIGN KEY (`patient_id`) REFERENCES `patient_info` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='医疗报告表';

-- ====================================================
-- 6. AI问诊记录表 (ai_consultation)
-- ====================================================
DROP TABLE IF EXISTS `ai_consultation`;
CREATE TABLE `ai_consultation` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `patient_id` BIGINT NOT NULL COMMENT '患者ID(外键)',
  `session_id` VARCHAR(50) NOT NULL COMMENT '会话ID',
  `question` TEXT NOT NULL COMMENT '用户提问',
  `ai_response` TEXT NOT NULL COMMENT 'AI回复',
  `consultation_type` VARCHAR(20) NOT NULL COMMENT '问诊类型(SYMPTOM_ANALYSIS/MEDICATION_GUIDE/HEALTH_KNOWLEDGE)',
  `tokens_used` INT DEFAULT NULL COMMENT '消耗token数',
  `response_time` INT DEFAULT NULL COMMENT '响应时间(ms)',
  `feedback` TINYINT DEFAULT NULL COMMENT '反馈(1:有帮助 0:无帮助)',
  `feedback_content` VARCHAR(200) DEFAULT NULL COMMENT '反馈内容',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_patient_id` (`patient_id`),
  KEY `idx_session_id` (`session_id`),
  KEY `idx_consultation_type` (`consultation_type`),
  KEY `idx_create_time` (`create_time`),
  CONSTRAINT `fk_consultation_patient` FOREIGN KEY (`patient_id`) REFERENCES `patient_info` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AI问诊记录表';

-- ====================================================
-- 7. 预约记录表 (appointment)
-- ====================================================
DROP TABLE IF EXISTS `appointment`;
CREATE TABLE `appointment` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '预约ID',
  `patient_id` BIGINT NOT NULL COMMENT '患者ID(外键)',
  `doctor_id` BIGINT NOT NULL COMMENT '医生ID(外键)',
  `appointment_date` DATE NOT NULL COMMENT '预约日期',
  `appointment_time` VARCHAR(20) NOT NULL COMMENT '预约时段',
  `department` VARCHAR(50) NOT NULL COMMENT '就诊科室',
  `symptoms` TEXT DEFAULT NULL COMMENT '症状描述',
  `status` TINYINT NOT NULL DEFAULT 0 COMMENT '状态(0:待就诊 1:已就诊 2:已取消)',
  `cancel_reason` VARCHAR(200) DEFAULT NULL COMMENT '取消原因',
  `diagnosis` TEXT DEFAULT NULL COMMENT '诊断结果',
  `prescription` TEXT DEFAULT NULL COMMENT '处方',
  `fee` DECIMAL(10,2) DEFAULT NULL COMMENT '费用',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_patient_id` (`patient_id`),
  KEY `idx_doctor_id` (`doctor_id`),
  KEY `idx_appointment_date` (`appointment_date`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_appointment_patient` FOREIGN KEY (`patient_id`) REFERENCES `patient_info` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_appointment_doctor` FOREIGN KEY (`doctor_id`) REFERENCES `doctor_info` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='预约记录表';

-- ====================================================
-- 8. 医生排班表 (doctor_schedule)
-- ====================================================
DROP TABLE IF EXISTS `doctor_schedule`;
CREATE TABLE `doctor_schedule` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '排班ID',
  `doctor_id` BIGINT NOT NULL COMMENT '医生ID(外键)',
  `schedule_date` DATE NOT NULL COMMENT '排班日期',
  `time_period` VARCHAR(20) NOT NULL COMMENT '时段(上午/下午)',
  `max_patients` INT NOT NULL DEFAULT 20 COMMENT '最大接诊数',
  `booked_patients` INT NOT NULL DEFAULT 0 COMMENT '已预约数',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态(0:停诊 1:可预约)',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_doctor_id` (`doctor_id`),
  KEY `idx_schedule_date` (`schedule_date`),
  KEY `idx_status` (`status`),
  UNIQUE KEY `uk_doctor_date_period` (`doctor_id`, `schedule_date`, `time_period`),
  CONSTRAINT `fk_schedule_doctor` FOREIGN KEY (`doctor_id`) REFERENCES `doctor_info` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='医生排班表';

-- ====================================================
-- 9. 用药提醒表 (medication_reminder)
-- ====================================================
DROP TABLE IF EXISTS `medication_reminder`;
CREATE TABLE `medication_reminder` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '提醒ID',
  `patient_id` BIGINT NOT NULL COMMENT '患者ID(外键)',
  `medicine_name` VARCHAR(100) NOT NULL COMMENT '药品名称',
  `dosage` VARCHAR(50) NOT NULL COMMENT '剂量',
  `frequency` VARCHAR(50) NOT NULL COMMENT '频率(每日3次/每日2次)',
  `usage_method` VARCHAR(100) DEFAULT NULL COMMENT '用法(饭前/饭后)',
  `start_date` DATE NOT NULL COMMENT '开始日期',
  `end_date` DATE NOT NULL COMMENT '结束日期',
  `reminder_times` VARCHAR(100) NOT NULL COMMENT '提醒时间(08:00,12:00,18:00)',
  `remark` VARCHAR(200) DEFAULT NULL COMMENT '备注',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态(0:已停用 1:进行中 2:已完成)',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_patient_id` (`patient_id`),
  KEY `idx_status` (`status`),
  KEY `idx_date_range` (`start_date`, `end_date`),
  CONSTRAINT `fk_reminder_patient` FOREIGN KEY (`patient_id`) REFERENCES `patient_info` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用药提醒表';

-- ====================================================
-- 10. 用药记录表 (medication_record)
-- ====================================================
DROP TABLE IF EXISTS `medication_record`;
CREATE TABLE `medication_record` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `reminder_id` BIGINT NOT NULL COMMENT '提醒ID(外键)',
  `patient_id` BIGINT NOT NULL COMMENT '患者ID(外键)',
  `medicine_name` VARCHAR(100) NOT NULL COMMENT '药品名称',
  `planned_time` DATETIME NOT NULL COMMENT '计划用药时间',
  `actual_time` DATETIME DEFAULT NULL COMMENT '实际用药时间',
  `status` TINYINT NOT NULL DEFAULT 0 COMMENT '状态(0:未服用 1:已服用 2:已忽略)',
  `remark` VARCHAR(200) DEFAULT NULL COMMENT '备注',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_reminder_id` (`reminder_id`),
  KEY `idx_patient_id` (`patient_id`),
  KEY `idx_planned_time` (`planned_time`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_record_reminder` FOREIGN KEY (`reminder_id`) REFERENCES `medication_reminder` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_record_patient` FOREIGN KEY (`patient_id`) REFERENCES `patient_info` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用药记录表';

-- ====================================================
-- 11. 系统通知表 (system_notification)
-- ====================================================
DROP TABLE IF EXISTS `system_notification`;
CREATE TABLE `system_notification` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '通知ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID(外键)',
  `title` VARCHAR(100) NOT NULL COMMENT '通知标题',
  `content` TEXT NOT NULL COMMENT '通知内容',
  `type` VARCHAR(20) NOT NULL COMMENT '类型(SYSTEM/APPOINTMENT/MEDICATION/REPORT)',
  `link_url` VARCHAR(255) DEFAULT NULL COMMENT '关联链接',
  `is_read` TINYINT NOT NULL DEFAULT 0 COMMENT '是否已读(0:未读 1:已读)',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `read_time` DATETIME DEFAULT NULL COMMENT '阅读时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_is_read` (`is_read`),
  KEY `idx_type` (`type`),
  KEY `idx_create_time` (`create_time`),
  CONSTRAINT `fk_notification_user` FOREIGN KEY (`user_id`) REFERENCES `sys_user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统通知表';

-- ====================================================
-- 12. 健康知识库表 (health_knowledge)
-- ====================================================
DROP TABLE IF EXISTS `health_knowledge`;
CREATE TABLE `health_knowledge` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '知识ID',
  `title` VARCHAR(200) NOT NULL COMMENT '标题',
  `category` VARCHAR(50) NOT NULL COMMENT '分类',
  `tags` VARCHAR(200) DEFAULT NULL COMMENT '标签',
  `cover_image` VARCHAR(255) DEFAULT NULL COMMENT '封面图',
  `summary` VARCHAR(500) DEFAULT NULL COMMENT '摘要',
  `content` LONGTEXT NOT NULL COMMENT '内容',
  `author` VARCHAR(50) DEFAULT NULL COMMENT '作者',
  `source` VARCHAR(100) DEFAULT NULL COMMENT '来源',
  `view_count` INT DEFAULT 0 COMMENT '浏览量',
  `like_count` INT DEFAULT 0 COMMENT '点赞数',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态(0:草稿 1:已发布)',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `publish_time` DATETIME DEFAULT NULL COMMENT '发布时间',
  PRIMARY KEY (`id`),
  KEY `idx_category` (`category`),
  KEY `idx_status` (`status`),
  KEY `idx_publish_time` (`publish_time`),
  FULLTEXT KEY `ft_title_content` (`title`, `content`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='健康知识库表';

-- ====================================================
-- 初始化数据
-- ====================================================

-- 插入管理员账号 (密码: admin123, 使用BCrypt加密)
INSERT INTO `sys_user` (`username`, `password`, `nickname`, `phone`, `email`, `role`, `status`) VALUES
('admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '系统管理员', '13800000000', 'admin@medical.com', 'ADMIN', 1);

-- 插入测试医生账号 (密码: doctor123)
INSERT INTO `sys_user` (`username`, `password`, `nickname`, `phone`, `email`, `role`, `status`) VALUES
('doctor1', '$2a$10$EI0Wq9JJ0RMUj0QaWXB1O.WaLNZPSzrqKqXvXLJqGqQgYN5qTiH9u', '李医生', '13800000001', 'doctor1@medical.com', 'DOCTOR', 1),
('doctor2', '$2a$10$EI0Wq9JJ0RMUj0QaWXB1O.WaLNZPSzrqKqXvXLJqGqQgYN5qTiH9u', '王医生', '13800000002', 'doctor2@medical.com', 'DOCTOR', 1),
('doctor3', '$2a$10$EI0Wq9JJ0RMUj0QaWXB1O.WaLNZPSzrqKqXvXLJqGqQgYN5qTiH9u', '张医生', '13800000003', 'doctor3@medical.com', 'DOCTOR', 1);

-- 插入测试患者账号 (密码: patient123)
INSERT INTO `sys_user` (`username`, `password`, `nickname`, `phone`, `email`, `role`, `status`) VALUES
('patient1', '$2a$10$xQZqHcJJ0RMUj0QaWXB1O.WaLNZPSzrqKqXvXLJqGqQgYN5qTiH9u', '张三', '13900000001', 'patient1@test.com', 'PATIENT', 1),
('patient2', '$2a$10$xQZqHcJJ0RMUj0QaWXB1O.WaLNZPSzrqKqXvXLJqGqQgYN5qTiH9u', '李四', '13900000002', 'patient2@test.com', 'PATIENT', 1);

-- 插入医生详细信息
INSERT INTO `doctor_info` (`user_id`, `real_name`, `gender`, `department`, `title`, `specialty`, `introduction`, `work_years`, `consultation_fee`, `rating`, `patient_count`) VALUES
(2, '李建国', 1, '内科', '主任医师', '心血管疾病、高血压、冠心病', '从事内科临床工作30余年，擅长心血管疾病的诊断与治疗', 30, 80.00, 4.9, 1500),
(3, '王芳', 0, '儿科', '副主任医师', '儿童常见病、呼吸系统疾病', '儿科临床经验丰富，对儿童呼吸系统疾病有深入研究', 15, 60.00, 4.8, 1200),
(4, '张伟', 1, '外科', '主治医师', '骨科、创伤外科', '擅长骨折、关节疾病的治疗，手术经验丰富', 10, 50.00, 4.7, 800);

-- 插入患者详细信息
INSERT INTO `patient_info` (`user_id`, `real_name`, `gender`, `birthday`, `age`, `id_card`, `address`, `emergency_contact`, `emergency_phone`, `height`, `weight`, `blood_type`, `allergies`, `family_history`) VALUES
(5, '张三', 1, '1990-05-15', 34, '110101199005151234', '北京市朝阳区XX街道XX号', '李四', '13900000002', 175.00, 70.00, 'A', '青霉素过敏', '父亲有高血压病史'),
(6, '李四', 0, '1995-08-20', 29, '110101199508202345', '北京市海淀区XX路XX号', '张三', '13900000001', 165.00, 55.00, 'B', '无', '无');

-- 插入医生排班数据（未来7天）
INSERT INTO `doctor_schedule` (`doctor_id`, `schedule_date`, `time_period`, `max_patients`, `booked_patients`, `status`) VALUES
(1, DATE_ADD(CURDATE(), INTERVAL 1 DAY), '上午', 20, 5, 1),
(1, DATE_ADD(CURDATE(), INTERVAL 1 DAY), '下午', 20, 3, 1),
(1, DATE_ADD(CURDATE(), INTERVAL 2 DAY), '上午', 20, 0, 1),
(2, DATE_ADD(CURDATE(), INTERVAL 1 DAY), '上午', 15, 8, 1),
(2, DATE_ADD(CURDATE(), INTERVAL 1 DAY), '下午', 15, 5, 1),
(3, DATE_ADD(CURDATE(), INTERVAL 1 DAY), '上午', 18, 2, 1),
(3, DATE_ADD(CURDATE(), INTERVAL 2 DAY), '下午', 18, 0, 1);

-- 插入健康知识示例数据
INSERT INTO `health_knowledge` (`title`, `category`, `tags`, `summary`, `content`, `author`, `status`, `publish_time`) VALUES
('高血压患者的饮食注意事项', '慢性病管理', '高血压,饮食,健康', '高血压是常见的慢性疾病，合理的饮食对控制血压至关重要。', 
'# 高血压患者的饮食注意事项\n\n## 1. 低盐饮食\n每日食盐摄入量应控制在6克以内...\n\n## 2. 多吃新鲜蔬果\n蔬菜水果富含钾元素，有助于降低血压...\n\n## 3. 控制脂肪摄入\n减少饱和脂肪和反式脂肪的摄入...', 
'健康管理中心', 1, NOW()),

('糖尿病的预防与控制', '慢性病管理', '糖尿病,预防,血糖', '糖尿病是一种代谢性疾病，早期预防和控制非常重要。', 
'# 糖尿病的预防与控制\n\n## 预防措施\n1. 保持健康体重\n2. 规律运动\n3. 均衡饮食\n\n## 控制方法\n1. 定期监测血糖\n2. 合理用药\n3. 饮食控制...', 
'健康管理中心', 1, NOW()),

('如何提高免疫力', '健康养生', '免疫力,养生,健康', '提高免疫力是预防疾病的关键，本文介绍科学的方法。', 
'# 如何提高免疫力\n\n## 1. 充足睡眠\n成年人每天应保证7-9小时睡眠...\n\n## 2. 均衡营养\n多摄入优质蛋白质、维生素和矿物质...\n\n## 3. 适量运动\n每周至少150分钟中等强度运动...', 
'健康管理中心', 1, NOW());

-- ====================================================
-- 创建视图（可选）
-- ====================================================

-- 患者健康概览视图
CREATE OR REPLACE VIEW `v_patient_health_overview` AS
SELECT 
  p.id AS patient_id,
  p.real_name,
  p.gender,
  p.age,
  p.blood_type,
  u.phone,
  COUNT(DISTINCT hd.id) AS health_data_count,
  COUNT(DISTINCT mr.id) AS report_count,
  COUNT(DISTINCT a.id) AS appointment_count
FROM patient_info p
LEFT JOIN sys_user u ON p.user_id = u.id
LEFT JOIN health_data hd ON p.id = hd.patient_id
LEFT JOIN medical_report mr ON p.id = mr.patient_id
LEFT JOIN appointment a ON p.id = a.patient_id
GROUP BY p.id;

-- 医生工作统计视图
CREATE OR REPLACE VIEW `v_doctor_statistics` AS
SELECT 
  d.id AS doctor_id,
  d.real_name,
  d.department,
  d.title,
  d.rating,
  d.patient_count,
  COUNT(DISTINCT a.id) AS total_appointments,
  COUNT(DISTINCT CASE WHEN a.status = 0 THEN a.id END) AS pending_appointments,
  COUNT(DISTINCT CASE WHEN a.status = 1 THEN a.id END) AS completed_appointments
FROM doctor_info d
LEFT JOIN appointment a ON d.id = a.doctor_id
GROUP BY d.id;

-- ====================================================
-- 创建存储过程（可选）
-- ====================================================

-- 自动计算年龄的存储过程
DELIMITER $$
CREATE PROCEDURE `sp_update_patient_age`()
BEGIN
  UPDATE patient_info 
  SET age = TIMESTAMPDIFF(YEAR, birthday, CURDATE())
  WHERE birthday IS NOT NULL;
END$$
DELIMITER ;

-- 生成用药记录的存储过程
DELIMITER $$
CREATE PROCEDURE `sp_generate_medication_records`(IN p_reminder_id BIGINT)
BEGIN
  DECLARE v_patient_id BIGINT;
  DECLARE v_medicine_name VARCHAR(100);
  DECLARE v_start_date DATE;
  DECLARE v_end_date DATE;
  DECLARE v_reminder_times VARCHAR(100);
  DECLARE v_current_date DATE;
  DECLARE v_time VARCHAR(10);
  DECLARE done INT DEFAULT 0;
  DECLARE time_cursor CURSOR FOR 
    SELECT TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(v_reminder_times, ',', numbers.n), ',', -1)) AS time
    FROM (SELECT 1 n UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5) numbers
    WHERE CHAR_LENGTH(v_reminder_times) - CHAR_LENGTH(REPLACE(v_reminder_times, ',', '')) >= numbers.n - 1;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
  
  -- 获取提醒信息
  SELECT patient_id, medicine_name, start_date, end_date, reminder_times
  INTO v_patient_id, v_medicine_name, v_start_date, v_end_date, v_reminder_times
  FROM medication_reminder
  WHERE id = p_reminder_id;
  
  -- 遍历日期
  SET v_current_date = v_start_date;
  WHILE v_current_date <= v_end_date DO
    -- 遍历每天的提醒时间
    OPEN time_cursor;
    read_loop: LOOP
      FETCH time_cursor INTO v_time;
      IF done THEN
        LEAVE read_loop;
      END IF;
      
      -- 插入用药记录
      INSERT INTO medication_record (reminder_id, patient_id, medicine_name, planned_time, status)
      VALUES (p_reminder_id, v_patient_id, v_medicine_name, CONCAT(v_current_date, ' ', v_time, ':00'), 0);
    END LOOP;
    CLOSE time_cursor;
    SET done = 0;
    
    SET v_current_date = DATE_ADD(v_current_date, INTERVAL 1 DAY);
  END WHILE;
END$$
DELIMITER ;

-- ====================================================
-- 创建触发器
-- ====================================================

-- 预约成功后更新医生排班的已预约数
DELIMITER $$
CREATE TRIGGER `tr_appointment_insert` AFTER INSERT ON `appointment`
FOR EACH ROW
BEGIN
  IF NEW.status = 0 THEN
    UPDATE doctor_schedule 
    SET booked_patients = booked_patients + 1
    WHERE doctor_id = NEW.doctor_id 
      AND schedule_date = NEW.appointment_date 
      AND time_period = NEW.appointment_time;
  END IF;
END$$
DELIMITER ;

-- 取消预约后更新医生排班的已预约数
DELIMITER $$
CREATE TRIGGER `tr_appointment_update` AFTER UPDATE ON `appointment`
FOR EACH ROW
BEGIN
  IF OLD.status = 0 AND NEW.status = 2 THEN
    UPDATE doctor_schedule 
    SET booked_patients = booked_patients - 1
    WHERE doctor_id = NEW.doctor_id 
      AND schedule_date = NEW.appointment_date 
      AND time_period = NEW.appointment_time
      AND booked_patients > 0;
  END IF;
END$$
DELIMITER ;

-- 更新患者年龄触发器
DELIMITER $$
CREATE TRIGGER `tr_patient_age_update` BEFORE UPDATE ON `patient_info`
FOR EACH ROW
BEGIN
  IF NEW.birthday IS NOT NULL AND NEW.birthday != OLD.birthday THEN
    SET NEW.age = TIMESTAMPDIFF(YEAR, NEW.birthday, CURDATE());
  END IF;
END$$
DELIMITER ;

SET FOREIGN_KEY_CHECKS = 1;

-- ====================================================
-- 脚本执行完成
-- ====================================================
SELECT '数据库初始化完成！' AS message;
SELECT CONCAT('共创建 ', COUNT(*), ' 张表') AS table_count FROM information_schema.tables WHERE table_schema = DATABASE();

